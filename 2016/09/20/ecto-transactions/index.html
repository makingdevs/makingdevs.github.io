<!DOCTYPE html>
<html lang="en">
<head prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# website: http://ogp.me/ns/website#">
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
    <meta name="description" content="">
    <meta property="og:title" content="Ecto Transactions">
    
    <meta property="og:type" content="article">
    <meta property="article:published_time" content="2016-09-20">
    
    <meta property="og:description" content="">
    <meta property="og:url" content="http://blog.makingdevs.com/2016/09/20/ecto-transactions">
    <meta property="og:site_name" content="Blog de Making Devs">
    
    <meta property="og:tags" content="elixir">
    
    <meta property="og:tags" content="ecto">
    
    <meta name="generator" content="Hugo 0.16" />
    <title>Ecto Transactions &middot; Blog de Making Devs</title>
    
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.3.0/css/font-awesome.min.css">
    
    <link rel="stylesheet" href="http://blog.makingdevs.com/css/style.css">
    <link href="" rel="alternate" type="application/rss+xml" title="Blog de Making Devs" />

    
    
</head>
<body>
<nav class="navbar navbar-default navbar-fixed-top visible-xs">
	<div class="container-fluid">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
				<span class="sr-only">Toggle navigation</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			
				<a class="navbar-brand" href="http://blog.makingdevs.com/">Blog de Making Devs</a>
			
		</div>
		<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
			<ul class="nav navbar-nav">
				
				
			</ul>
		</div>
	</div>
</nav>
<div class="container-fluid">
	<div class="row">
		<div id="menu" class="hidden-xs col-sm-4 col-md-3">
	<div id="menu-content" class="vertical-align">
		
			<h1 class="text-center"><a href="http://blog.makingdevs.com/"></a></h1>
		

		
			<small class="text-center center-block">El c√≥digo que a veces olvidamos documentar.</small>
		

		
    <a href="http://blog.makingdevs.com/"><img id="profile-pic" src="http://blog.makingdevs.com//profile.jpeg" alt="My Picture" class="img-circle center-block"></a>
		
		<div id="social" class="text-center">
			<a href="https://twitter.com/makingdevs"><i class="fa fa-twitter fa-2x"></i></a>
			
			<a href="https://github.com/makingdevs"><i class="fa fa-github fa-2x"></i></a>
			<a href="mailto:info@makingdevs.com"><i class="fa fa-envelope-o fa-2x"></i></a>
		</div>
		<div id="links" class="text-center">
			
			
		</div>
	</div>
</div>

		<div id="content" class="col-xs-12 col-sm-8 col-md-9">
			<div class="row">
				<div id="post" class="col-sm-offset-1 col-sm-10 col-md-10 col-lg-8">

<main>
	<header>
		<h1 align=center>Ecto Transactions</h1>
    
     <section class="author">
       <p align=center> <b>Redactado por: Felipe Juarez</b></p>
     </section>
    

  </header>
  </br>
	<article>
		<p>It has been a couple of months since I wrote something and was about <code>phoenix</code> and <code>bootstrap</code>. Today I&rsquo;m going to talk about <code>elixir</code>, <code>ecto</code> and how to manage <code>transactions</code></p>

<p>Well in this post we are going to skip <code>ecto setup</code> (if for some way, it was need it, please leave a comment and I will make a post for it, but I think his <a href="https://github.com/elixir-ecto/ecto">documentation</a> makes a fairly good example for it)</p>

<p>With that in mind, these are the tables that we are going to use.</p>

<ul>
<li><p>Project table

defmodule EctoTransactions.Project do
  use Ecto.Schema
  import Ecto.Changeset

  schema "projects" do
    field :name
    has_many :tasks, EctoTransactions.Task

    timestamps
  end

  def changeset(struct, params \\ %{}) do
    struct
    |> cast(params, [:name])
    |> validate_required([:name])
  end

end
</p></li>

<li><p>Task table

defmodule EctoTransactions.Task do
  use Ecto.Schema

  import Ecto.Changeset

  schema "tasks" do
    field :description
    belongs_to :project, EctoTransactions.Project

    timestamps
  end

  def changeset(struct, params \\ %{}) do
    struct
    |> cast(params, [:description, :project_id])
    |> validate_required([:description, :project_id])
  end
end
</p></li>
</ul>

<p>With both tables we can see that <code>Task</code> depends from <code>Project</code>. So we are going to create a <code>project</code> with a <code>task</code> and we are going to see how can we handle a creation like that.</p>

<p>The first thing we should know is, how can we create a transaction? With this instruction <code>Repo.transaction(fn -&gt; end)</code> Between <code>arrow</code> and <code>end</code> we put the code that we need. And for making a <code>rollback</code> we use <code>Repo.rollback(value)</code> and between parenthesis we can indicate the reason of why we are making that decision.</p>

<p>So we are going to create a module for handling this</p>


  defmodule EctoTransactions.App do

    import Ecto
    alias EctoTransactions.Repo
    alias EctoTransactions.Project
    alias EctoTransactions.Task

    # creating project and task
    def create_project_with_task(project_params, task_params) do
      Repo.transaction(fn ->
        project_params
        |> create_project_with_params
        |> add_task_to_project(task_params)
      end)
    end

    # creating project
    defp create_project_with_params(project_params) do
      %Project{}
      |> Project.changeset(project_params)
      |> Repo.insert
    end

    # adding a task to a valid project
    defp add_task_to_project({:ok, project}, task_params) do
      changeset = project
                  |> build_assoc(:tasks)
                  |> Task.changeset(task_params)

      case Repo.insert(changeset) do
        {:ok, _task} -> project
        {:error, changeset} -> Repo.rollback(:task) # Rollback transaction for invalid task data
      end
    end
    defp add_task_to_project({:error, _changeset}, _task_params),
    do: Repo.rollback(:project) # Rollback transaction for invalid project data

  end


<p>So if we use <code>iex -S mix</code> and passing some args to this we can obtain the following results</p>

<ul>
<li>Passing good options

iex(1)> project_params = %{name: "Explain ecto transactions"}
%{name: "Explain ecto transactions"}
iex(2)> task_params = %{description: "Should create task for example"}
%{description: "Should create task for example"}
iex(3)> EctoTransactions.App.create_project_with_task(project_params, task_params)

22:28:59.905 [debug] QUERY OK db=0.2ms queue=0.1ms
begin []

22:28:59.917 [debug] QUERY OK db=0.9ms
INSERT INTO "projects" ("name","inserted_at","updated_at") VALUES ($1,$2,$3) RETURNING "id" ["Explain ecto transactions", {{2016, 9, 21}, {3, 28, 59, 0}}, {{2016, 9, 21}, {3, 28, 59, 0}}]

22:28:59.921 [debug] QUERY OK db=3.1ms
INSERT INTO "tasks" ("description","project_id","inserted_at","updated_at") VALUES ($1,$2,$3,$4) RETURNING "id" ["Should create task for example", 1, {{2016, 9, 21}, {3, 28, 59, 0}}, {{2016, 9, 21}, {3, 28, 59, 0}}]

22:28:59.922 [debug] QUERY OK db=0.3ms
commit []
{:ok,
 %EctoTransactions.Project{__meta__: #Ecto.Schema.Metadata<:loaded, "projects">,
  id: 1, inserted_at: #Ecto.DateTime<2016-09-21 03:28:59>,
  name: "Explain ecto transactions",
  tasks: #Ecto.Association.NotLoaded<association :tasks is not loaded>,
  updated_at: #Ecto.DateTime<2016-09-21 03:28:59>}}
</li>
</ul>


ecto_simple> select * from projects; select * from tasks;
+------+---------------------------+---------------------+---------------------+
|   id | name                      | inserted_at         | updated_at          |
|------+---------------------------+---------------------+---------------------|
|    1 | Explain ecto transactions | 2016-09-21 03:28:59 | 2016-09-21 03:28:59 |
+------+---------------------------+---------------------+---------------------+
SELECT 1
+------+--------------------------------+--------------+---------------------+---------------------+
|   id | description                    |   project_id | inserted_at         | updated_at          |
|------+--------------------------------+--------------+---------------------+---------------------|
|    1 | Should create task for example |            1 | 2016-09-21 03:28:59 | 2016-09-21 03:28:59 |
+------+--------------------------------+--------------+---------------------+---------------------+
SELECT 1
Time: 0.003s


<p>And for bad data we can obtain next results:</p>


iex(4)> project_params = %{name: 1}
%{name: 1}
iex(5)> task_params = %{description: nil}
%{description: nil}
iex(6)> EctoTransactions.App.create_project_with_task(project_params, task_params)

22:49:25.863 [debug] QUERY OK db=0.2ms
begin []

22:49:25.865 [debug] QUERY OK db=0.2ms
rollback []
{:error, :project}

iex(7)> project_params = %{name: "Explain ecto transactions"}
%{name: "Explain ecto transactions"}
iex(8)> EctoTransactions.App.create_project_with_task(project_params, task_params)

22:49:53.345 [debug] QUERY OK db=0.3ms queue=0.1ms
begin []

22:49:53.346 [debug] QUERY OK db=1.2ms
INSERT INTO "projects" ("name","inserted_at","updated_at") VALUES ($1,$2,$3) RETURNING "id" ["Explain ecto transactions", {{2016, 9, 21}, {3, 49, 53, 0}}, {{2016, 9, 21}, {3, 49, 53, 0}}]
#Ecto.Changeset<action: :insert, changes: %{},
 errors: [description: {"can't be blank", []}], data: #EctoTransactions.Task<>,
 valid?: false>

22:49:53.348 [debug] QUERY OK db=0.2ms
rollback []
{:error, :task}
iex(9)>


<p>If you read with attention you will see two tupples <code>{:error, :project}</code> and <code>{:error, :task}</code> with this you can make the assumptions that you want, of course you could say a lot more and instead of returning tupples you return other things with more sense for example change <code>:project</code> or <code>:task</code> for his respective <code>changeset</code> and you should see other things.</p>

<p>By the way when use <code>Repo.transaction</code> you should return the implicit data (that is the schema you are saving) that&rsquo;s because <code>Repo.transaction</code> return a tupple consisting of an <code>:ok</code> atom and the respective last instruction. And if you use <code>Repo.insert</code> as returning data you will see a tupple of tupple <code>{:ok, {:ok, data}}</code> or <code>{:ok, {:error, data}}</code> (thats because the return of an insert is <code>{:ok, data}</code> or <code>{:error, data}</code>) and that&rsquo;s why we use <code>Repo.rollback</code> for forcing a tupple consisting of <code>{:error, reason}</code></p>

<p>That&rsquo;s all folks! I hope this can help you. And remember Good Luck, Have Fun! and GG!</p>

	</article>
</main>

<div id="bottom-nav" class="text-center center-block">
	<a href=" http://blog.makingdevs.com/" class="btn btn-default"><i class="fa fa-home"></i> Home</a>
</div>


  <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'makingdevs';
    var disqus_identifier = 'http:\/\/blog.makingdevs.com\/2016\/09\/20\/ecto-transactions';
    var disqus_title = 'Ecto Transactions';
    var disqus_url = 'http:\/\/blog.makingdevs.com\/2016\/09\/20\/ecto-transactions';

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


						</div>
					</div>
				</div>
			</div>
		</div>
  </div>
  
  <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.2/js/bootstrap.min.js"></script>
  
  <script src="//cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/topojson/1.6.9/topojson.min.js"></script>
  
  
  <script src="http://blog.makingdevs.com//js/App.js"></script>
  
</body>
</html>
