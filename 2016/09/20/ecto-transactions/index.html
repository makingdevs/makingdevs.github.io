<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/WebPage">
  <head>
    

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <title>Ecto Transactions - Blog de Making Devs</title>
  <meta name="description" content="It has been a couple of months since I wrote something and was about phoenix and bootstrap. Today I&rsquo;m going to talk about elixir, ecto and how to manage transactions
Well in this post we are going to skip ecto setup (if for some way, it was need it, please leave a comment and I will make a post for it, but I think his documentation makes a fairly good example for it)"><script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "WebSite",
    "name": "Blog de Making Devs",
    
    "url": "https:\/\/blog.makingdevs.com\/"
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Organization",
  "name": "",
  "url": "https:\/\/blog.makingdevs.com\/"
  
  
  
  
}
</script>
<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [{
        "@type": "ListItem",
        "position": 1,
        "item": {
          "@id": "https:\/\/blog.makingdevs.com\/",
          "name": "home"
        }
    },{
        "@type": "ListItem",
        "position": 3,
        "item": {
          "@id": "https:\/\/blog.makingdevs.com\/2016\/09\/20\/ecto-transactions\/",
          "name": "Ecto transactions"
        }
    }]
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Article",
  "author": {
    "name" : "Felipe Juarez"
  },
  "headline": "Ecto Transactions",
  "description" : "It has been a couple of months since I wrote something and was about phoenix and bootstrap. Today I\u0026rsquo;m going to talk about elixir, ecto and how to manage transactions\nWell in this post we are going to skip ecto setup (if for some way, it was need it, please leave a comment and I will make a post for it, but I think his documentation makes a fairly good example for it)",
  "inLanguage" : "en",
  "wordCount":  852 ,
  "datePublished" : "2016-09-20T19:35:08",
  "dateModified" : "2016-09-20T19:35:08",
  "image" : "https:\/\/blog.makingdevs.com\/images\/logo_black.png",
  "keywords" : [ "elixir, ecto" ],
  "mainEntityOfPage" : "https:\/\/blog.makingdevs.com\/2016\/09\/20\/ecto-transactions\/",
  "publisher" : {
    "@type": "Organization",
    "name" : "https:\/\/blog.makingdevs.com\/",
    "logo" : {
        "@type" : "ImageObject",
        "url" : "https:\/\/blog.makingdevs.com\/images\/logo_black.png",
        "height" :  60 ,
        "width" :  60
    }
  }
}
</script>

<meta property="og:title" content="Ecto Transactions" />
<meta property="og:description" content="It has been a couple of months since I wrote something and was about phoenix and bootstrap. Today I&rsquo;m going to talk about elixir, ecto and how to manage transactions
Well in this post we are going to skip ecto setup (if for some way, it was need it, please leave a comment and I will make a post for it, but I think his documentation makes a fairly good example for it)">
<meta property="og:image" content="https://blog.makingdevs.com/images/logo_black.png" />
<meta property="og:url" content="https://blog.makingdevs.com/2016/09/20/ecto-transactions/" />
<meta property="og:type" content="website" />
<meta property="og:site_name" content="Blog de Making Devs" />

  <meta name="twitter:title" content="Ecto Transactions" />
  <meta name="twitter:description" content="It has been a couple of months since I wrote something and was about phoenix and bootstrap. Today I&rsquo;m going to talk about elixir, ecto and how to manage transactions
Well in this post we are â€¦">
  <meta name="twitter:image" content="https://blog.makingdevs.com/images/logo_black.png" />
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@makingdevs" />
  <meta name="twitter:creator" content="@makingdevs" />
  <meta name="generator" content="Hugo 0.74.2" />
  <link rel="alternate" href="https://blog.makingdevs.com/index.xml" type="application/rss+xml" title="Blog de Making Devs"><link rel="stylesheet" href="https://blog.makingdevs.com/css/katex.min.css" />
  <link rel="stylesheet" href="https://blog.makingdevs.com/fontawesome/css/all.css" />
  <link rel="stylesheet" href="https://blog.makingdevs.com/css/bootstrap.min.css" /><link rel="stylesheet" href="https://blog.makingdevs.com/css/main.css" /><link rel="stylesheet" href="https://blog.makingdevs.com/css/fonts.css" />
  <link rel="stylesheet" href="https://blog.makingdevs.com/css/highlight.min.css" /><link rel="stylesheet" href="https://blog.makingdevs.com/css/codeblock.css" /><link rel="stylesheet" href="https://blog.makingdevs.com/css/photoswipe.min.css" />
  <link rel="stylesheet" href="https://blog.makingdevs.com/css/photoswipe.default-skin.min.css" />


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-42842883-2', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>


  </head>
  <body>
    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="https://blog.makingdevs.com/">Blog de Making Devs</a>
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
				
					
						<li>
							
								<a href="/2014/07/29/bienvenido-a-makingdevs/">Bienvenidos</a>
							
						</li>
					
				
					
						<li>
							
								<a title="Archive" href="/post"><i class="fas fa-archive fa-lg"></i></a>
							
						</li>
					
				
					
						<li>
							
								<a title="Categories" href="/categories"><i class="fas fa-sitemap fa-lg"></i></a>
							
						</li>
					
				
					
						<li>
							
								<a title="Tags" href="/tags"><i class='fas fa-tags fa-lg'></i></a>
							
						</li>
					
				

        

        
      </ul>
    </div>

    
      <div class="avatar-container">
        <div class="avatar-img-border">
          <a title="Blog de Making Devs" href="https://blog.makingdevs.com/">
            <img class="avatar-img" src="https://blog.makingdevs.com/images/logo_black.png" alt="Blog de Making Devs" />
          </a>
        </div>
      </div>
    

  </div>
</nav>




    


<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>


  
  
  






  

  <header class="header-section ">
    
    <div class="intro-header no-img">
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
            <div class="post-heading">
              
                <h1>Ecto Transactions</h1>
              
              
              
              
                <span class="post-meta">
  
  
  <i class="fas fa-calendar"></i>&nbsp;Posted on September 20, 2016
  
  
    &nbsp;|&nbsp;<i class="fas fa-clock"></i>&nbsp;4&nbsp;minutes
  
  
  
    
      &nbsp;|&nbsp;<i class="fas fa-user"></i>&nbsp;Felipe Juarez
    
  
  
</span>


              
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>


    
<div class="container" role="main">
  <div class="row">
    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
      <article role="main" class="blog-post">
        <p>It has been a couple of months since I wrote something and was about <code>phoenix</code> and <code>bootstrap</code>. Today I&rsquo;m going to talk about <code>elixir</code>, <code>ecto</code> and how to manage <code>transactions</code></p>
<p>Well in this post we are going to skip <code>ecto setup</code> (if for some way, it was need it, please leave a comment and I will make a post for it, but I think his <a href="https://github.com/elixir-ecto/ecto">documentation</a> makes a fairly good example for it)</p>
<p>With that in mind, these are the tables that we are going to use.</p>
<ul>
<li>
<p>Project table
<div class="highlight"><pre class="chroma"><code class="language-elixir" data-lang="elixir"><span class="n">defmodule</span> <span class="nc">EctoTransactions.Project</span> <span class="n">do</span>
  <span class="n">use</span> <span class="nc">Ecto.Schema</span>
  <span class="n">import</span> <span class="nc">Ecto.Changeset</span>

  <span class="n">schema</span> <span class="s2">&#34;projects&#34;</span> <span class="n">do</span>
    <span class="n">field</span> <span class="ss">:name</span>
    <span class="n">has_many</span> <span class="ss">:tasks</span><span class="p">,</span> <span class="nc">EctoTransactions.Task</span>

    <span class="n">timestamps</span>
  <span class="n">end</span>

  <span class="n">def</span> <span class="n">changeset</span><span class="p">(</span><span class="n">struct</span><span class="p">,</span> <span class="n">params</span> <span class="p">\\</span> <span class="p">%{})</span> <span class="n">do</span>
    <span class="n">struct</span>
    <span class="o">|&gt;</span> <span class="n">cast</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="p">[</span><span class="ss">:name</span><span class="p">])</span>
    <span class="o">|&gt;</span> <span class="n">validate_required</span><span class="p">([</span><span class="ss">:name</span><span class="p">])</span>
  <span class="n">end</span>

<span class="n">end</span></code></pre></div></p>
</li>
<li>
<p>Task table
<div class="highlight"><pre class="chroma"><code class="language-elixir" data-lang="elixir"><span class="n">defmodule</span> <span class="nc">EctoTransactions.Task</span> <span class="n">do</span>
  <span class="n">use</span> <span class="nc">Ecto.Schema</span>

  <span class="n">import</span> <span class="nc">Ecto.Changeset</span>

  <span class="n">schema</span> <span class="s2">&#34;tasks&#34;</span> <span class="n">do</span>
    <span class="n">field</span> <span class="ss">:description</span>
    <span class="n">belongs_to</span> <span class="ss">:project</span><span class="p">,</span> <span class="nc">EctoTransactions.Project</span>

    <span class="n">timestamps</span>
  <span class="n">end</span>

  <span class="n">def</span> <span class="n">changeset</span><span class="p">(</span><span class="n">struct</span><span class="p">,</span> <span class="n">params</span> <span class="p">\\</span> <span class="p">%{})</span> <span class="n">do</span>
    <span class="n">struct</span>
    <span class="o">|&gt;</span> <span class="n">cast</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="p">[</span><span class="ss">:description</span><span class="p">,</span> <span class="ss">:project_id</span><span class="p">])</span>
    <span class="o">|&gt;</span> <span class="n">validate_required</span><span class="p">([</span><span class="ss">:description</span><span class="p">,</span> <span class="ss">:project_id</span><span class="p">])</span>
  <span class="n">end</span>
<span class="n">end</span></code></pre></div></p>
</li>
</ul>
<p>With both tables we can see that <code>Task</code> depends from <code>Project</code>. So we are going to create a <code>project</code> with a <code>task</code> and we are going to see how can we handle a creation like that.</p>
<p>The first thing we should know is, how can we create a transaction? With this instruction <code>Repo.transaction(fn -&gt; end)</code> Between <code>arrow</code> and <code>end</code> we put the code that we need. And for making a <code>rollback</code> we use <code>Repo.rollback(value)</code> and between parenthesis we can indicate the reason of why we are making that decision.</p>
<p>So we are going to create a module for handling this</p>
<div class="highlight"><pre class="chroma"><code class="language-elixir" data-lang="elixir">  <span class="n">defmodule</span> <span class="nc">EctoTransactions.App</span> <span class="n">do</span>

    <span class="n">import</span> <span class="nc">Ecto</span>
    <span class="n">alias</span> <span class="nc">EctoTransactions.Repo</span>
    <span class="n">alias</span> <span class="nc">EctoTransactions.Project</span>
    <span class="n">alias</span> <span class="nc">EctoTransactions.Task</span>

    <span class="c1"># creating project and task</span>
    <span class="n">def</span> <span class="n">create_project_with_task</span><span class="p">(</span><span class="n">project_params</span><span class="p">,</span> <span class="n">task_params</span><span class="p">)</span> <span class="n">do</span>
      <span class="nc">Repo</span><span class="o">.</span><span class="n">transaction</span><span class="p">(</span><span class="n">fn</span> <span class="o">-&gt;</span>
        <span class="n">project_params</span>
        <span class="o">|&gt;</span> <span class="n">create_project_with_params</span>
        <span class="o">|&gt;</span> <span class="n">add_task_to_project</span><span class="p">(</span><span class="n">task_params</span><span class="p">)</span>
      <span class="n">end</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="c1"># creating project</span>
    <span class="n">defp</span> <span class="n">create_project_with_params</span><span class="p">(</span><span class="n">project_params</span><span class="p">)</span> <span class="n">do</span>
      <span class="p">%</span><span class="nc">Project</span><span class="p">{}</span>
      <span class="o">|&gt;</span> <span class="nc">Project</span><span class="o">.</span><span class="n">changeset</span><span class="p">(</span><span class="n">project_params</span><span class="p">)</span>
      <span class="o">|&gt;</span> <span class="nc">Repo</span><span class="o">.</span><span class="n">insert</span>
    <span class="n">end</span>

    <span class="c1"># adding a task to a valid project</span>
    <span class="n">defp</span> <span class="n">add_task_to_project</span><span class="p">({</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">project</span><span class="p">},</span> <span class="n">task_params</span><span class="p">)</span> <span class="n">do</span>
      <span class="n">changeset</span> <span class="o">=</span> <span class="n">project</span>
                  <span class="o">|&gt;</span> <span class="n">build_assoc</span><span class="p">(</span><span class="ss">:tasks</span><span class="p">)</span>
                  <span class="o">|&gt;</span> <span class="nc">Task</span><span class="o">.</span><span class="n">changeset</span><span class="p">(</span><span class="n">task_params</span><span class="p">)</span>

      <span class="n">case</span> <span class="nc">Repo</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">changeset</span><span class="p">)</span> <span class="n">do</span>
        <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">_task</span><span class="p">}</span> <span class="o">-&gt;</span> <span class="n">project</span>
        <span class="p">{</span><span class="ss">:error</span><span class="p">,</span> <span class="n">changeset</span><span class="p">}</span> <span class="o">-&gt;</span> <span class="nc">Repo</span><span class="o">.</span><span class="n">rollback</span><span class="p">(</span><span class="ss">:task</span><span class="p">)</span> <span class="c1"># Rollback transaction for invalid task data</span>
      <span class="n">end</span>
    <span class="n">end</span>
    <span class="n">defp</span> <span class="n">add_task_to_project</span><span class="p">({</span><span class="ss">:error</span><span class="p">,</span> <span class="n">_changeset</span><span class="p">},</span> <span class="n">_task_params</span><span class="p">),</span>
    <span class="ss">do</span><span class="p">:</span> <span class="nc">Repo</span><span class="o">.</span><span class="n">rollback</span><span class="p">(</span><span class="ss">:project</span><span class="p">)</span> <span class="c1"># Rollback transaction for invalid project data</span>

  <span class="n">end</span></code></pre></div>
<p>So if we use <code>iex -S mix</code> and passing some args to this we can obtain the following results</p>
<ul>
<li>Passing good options
<div class="highlight"><pre class="chroma"><code class="language-elixir" data-lang="elixir"><span class="n">iex</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">project_params</span> <span class="o">=</span> <span class="p">%{</span><span class="ss">name</span><span class="p">:</span> <span class="s2">&#34;Explain ecto transactions&#34;</span><span class="p">}</span>
<span class="p">%{</span><span class="ss">name</span><span class="p">:</span> <span class="s2">&#34;Explain ecto transactions&#34;</span><span class="p">}</span>
<span class="n">iex</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">task_params</span> <span class="o">=</span> <span class="p">%{</span><span class="ss">description</span><span class="p">:</span> <span class="s2">&#34;Should create task for example&#34;</span><span class="p">}</span>
<span class="p">%{</span><span class="ss">description</span><span class="p">:</span> <span class="s2">&#34;Should create task for example&#34;</span><span class="p">}</span>
<span class="n">iex</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">&gt;</span> <span class="nc">EctoTransactions.App</span><span class="o">.</span><span class="n">create_project_with_task</span><span class="p">(</span><span class="n">project_params</span><span class="p">,</span> <span class="n">task_params</span><span class="p">)</span>

<span class="mi">22</span><span class="p">:</span><span class="mi">28</span><span class="p">:</span><span class="mf">59.905</span> <span class="p">[</span><span class="n">debug</span><span class="p">]</span> <span class="nc">QUERY</span> <span class="nc">OK</span> <span class="n">db</span><span class="o">=</span><span class="mf">0.2</span><span class="n">ms</span> <span class="n">queue</span><span class="o">=</span><span class="mf">0.1</span><span class="n">ms</span>
<span class="n">begin</span> <span class="p">[]</span>

<span class="mi">22</span><span class="p">:</span><span class="mi">28</span><span class="p">:</span><span class="mf">59.917</span> <span class="p">[</span><span class="n">debug</span><span class="p">]</span> <span class="nc">QUERY</span> <span class="nc">OK</span> <span class="n">db</span><span class="o">=</span><span class="mf">0.9</span><span class="n">ms</span>
<span class="nc">INSERT</span> <span class="nc">INTO</span> <span class="s2">&#34;projects&#34;</span> <span class="p">(</span><span class="s2">&#34;name&#34;</span><span class="p">,</span><span class="s2">&#34;inserted_at&#34;</span><span class="p">,</span><span class="s2">&#34;updated_at&#34;</span><span class="p">)</span> <span class="nc">VALUES</span> <span class="p">(</span><span class="err">$</span><span class="mi">1</span><span class="p">,</span><span class="err">$</span><span class="mi">2</span><span class="p">,</span><span class="err">$</span><span class="mi">3</span><span class="p">)</span> <span class="nc">RETURNING</span> <span class="s2">&#34;id&#34;</span> <span class="p">[</span><span class="s2">&#34;Explain ecto transactions&#34;</span><span class="p">,</span> <span class="p">{{</span><span class="mi">2016</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">21</span><span class="p">},</span> <span class="p">{</span><span class="mi">3</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">59</span><span class="p">,</span> <span class="mi">0</span><span class="p">}},</span> <span class="p">{{</span><span class="mi">2016</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">21</span><span class="p">},</span> <span class="p">{</span><span class="mi">3</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">59</span><span class="p">,</span> <span class="mi">0</span><span class="p">}}]</span>

<span class="mi">22</span><span class="p">:</span><span class="mi">28</span><span class="p">:</span><span class="mf">59.921</span> <span class="p">[</span><span class="n">debug</span><span class="p">]</span> <span class="nc">QUERY</span> <span class="nc">OK</span> <span class="n">db</span><span class="o">=</span><span class="mf">3.1</span><span class="n">ms</span>
<span class="nc">INSERT</span> <span class="nc">INTO</span> <span class="s2">&#34;tasks&#34;</span> <span class="p">(</span><span class="s2">&#34;description&#34;</span><span class="p">,</span><span class="s2">&#34;project_id&#34;</span><span class="p">,</span><span class="s2">&#34;inserted_at&#34;</span><span class="p">,</span><span class="s2">&#34;updated_at&#34;</span><span class="p">)</span> <span class="nc">VALUES</span> <span class="p">(</span><span class="err">$</span><span class="mi">1</span><span class="p">,</span><span class="err">$</span><span class="mi">2</span><span class="p">,</span><span class="err">$</span><span class="mi">3</span><span class="p">,</span><span class="err">$</span><span class="mi">4</span><span class="p">)</span> <span class="nc">RETURNING</span> <span class="s2">&#34;id&#34;</span> <span class="p">[</span><span class="s2">&#34;Should create task for example&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">{{</span><span class="mi">2016</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">21</span><span class="p">},</span> <span class="p">{</span><span class="mi">3</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">59</span><span class="p">,</span> <span class="mi">0</span><span class="p">}},</span> <span class="p">{{</span><span class="mi">2016</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">21</span><span class="p">},</span> <span class="p">{</span><span class="mi">3</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">59</span><span class="p">,</span> <span class="mi">0</span><span class="p">}}]</span>

<span class="mi">22</span><span class="p">:</span><span class="mi">28</span><span class="p">:</span><span class="mf">59.922</span> <span class="p">[</span><span class="n">debug</span><span class="p">]</span> <span class="nc">QUERY</span> <span class="nc">OK</span> <span class="n">db</span><span class="o">=</span><span class="mf">0.3</span><span class="n">ms</span>
<span class="n">commit</span> <span class="p">[]</span>
<span class="p">{</span><span class="ss">:ok</span><span class="p">,</span>
 <span class="p">%</span><span class="nc">EctoTransactions.Project</span><span class="p">{</span><span class="ss">__meta__</span><span class="p">:</span> <span class="c1">#Ecto.Schema.Metadata&lt;:loaded, &#34;projects&#34;&gt;,</span>
  <span class="ss">id</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="ss">inserted_at</span><span class="p">:</span> <span class="c1">#Ecto.DateTime&lt;2016-09-21 03:28:59&gt;,</span>
  <span class="ss">name</span><span class="p">:</span> <span class="s2">&#34;Explain ecto transactions&#34;</span><span class="p">,</span>
  <span class="ss">tasks</span><span class="p">:</span> <span class="c1">#Ecto.Association.NotLoaded&lt;association :tasks is not loaded&gt;,</span>
  <span class="ss">updated_at</span><span class="p">:</span> <span class="c1">#Ecto.DateTime&lt;2016-09-21 03:28:59&gt;}}</span></code></pre></div></li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">ecto_simple&gt; select * from projects; select * from tasks;
+------+---------------------------+---------------------+---------------------+
|   id | name                      | inserted_at         | updated_at          |
|------+---------------------------+---------------------+---------------------|
|    1 | Explain ecto transactions | 2016-09-21 03:28:59 | 2016-09-21 03:28:59 |
+------+---------------------------+---------------------+---------------------+
SELECT 1
+------+--------------------------------+--------------+---------------------+---------------------+
|   id | description                    |   project_id | inserted_at         | updated_at          |
|------+--------------------------------+--------------+---------------------+---------------------|
|    1 | Should create task for example |            1 | 2016-09-21 03:28:59 | 2016-09-21 03:28:59 |
+------+--------------------------------+--------------+---------------------+---------------------+
SELECT 1
Time: 0.003s</code></pre></div>
<p>And for bad data we can obtain next results:</p>
<div class="highlight"><pre class="chroma"><code class="language-elixir" data-lang="elixir"><span class="n">iex</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">project_params</span> <span class="o">=</span> <span class="p">%{</span><span class="ss">name</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
<span class="p">%{</span><span class="ss">name</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
<span class="n">iex</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">task_params</span> <span class="o">=</span> <span class="p">%{</span><span class="ss">description</span><span class="p">:</span> <span class="n">nil</span><span class="p">}</span>
<span class="p">%{</span><span class="ss">description</span><span class="p">:</span> <span class="n">nil</span><span class="p">}</span>
<span class="n">iex</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">&gt;</span> <span class="nc">EctoTransactions.App</span><span class="o">.</span><span class="n">create_project_with_task</span><span class="p">(</span><span class="n">project_params</span><span class="p">,</span> <span class="n">task_params</span><span class="p">)</span>

<span class="mi">22</span><span class="p">:</span><span class="mi">49</span><span class="p">:</span><span class="mf">25.863</span> <span class="p">[</span><span class="n">debug</span><span class="p">]</span> <span class="nc">QUERY</span> <span class="nc">OK</span> <span class="n">db</span><span class="o">=</span><span class="mf">0.2</span><span class="n">ms</span>
<span class="n">begin</span> <span class="p">[]</span>

<span class="mi">22</span><span class="p">:</span><span class="mi">49</span><span class="p">:</span><span class="mf">25.865</span> <span class="p">[</span><span class="n">debug</span><span class="p">]</span> <span class="nc">QUERY</span> <span class="nc">OK</span> <span class="n">db</span><span class="o">=</span><span class="mf">0.2</span><span class="n">ms</span>
<span class="n">rollback</span> <span class="p">[]</span>
<span class="p">{</span><span class="ss">:error</span><span class="p">,</span> <span class="ss">:project</span><span class="p">}</span>

<span class="n">iex</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">project_params</span> <span class="o">=</span> <span class="p">%{</span><span class="ss">name</span><span class="p">:</span> <span class="s2">&#34;Explain ecto transactions&#34;</span><span class="p">}</span>
<span class="p">%{</span><span class="ss">name</span><span class="p">:</span> <span class="s2">&#34;Explain ecto transactions&#34;</span><span class="p">}</span>
<span class="n">iex</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="o">&gt;</span> <span class="nc">EctoTransactions.App</span><span class="o">.</span><span class="n">create_project_with_task</span><span class="p">(</span><span class="n">project_params</span><span class="p">,</span> <span class="n">task_params</span><span class="p">)</span>

<span class="mi">22</span><span class="p">:</span><span class="mi">49</span><span class="p">:</span><span class="mf">53.345</span> <span class="p">[</span><span class="n">debug</span><span class="p">]</span> <span class="nc">QUERY</span> <span class="nc">OK</span> <span class="n">db</span><span class="o">=</span><span class="mf">0.3</span><span class="n">ms</span> <span class="n">queue</span><span class="o">=</span><span class="mf">0.1</span><span class="n">ms</span>
<span class="n">begin</span> <span class="p">[]</span>

<span class="mi">22</span><span class="p">:</span><span class="mi">49</span><span class="p">:</span><span class="mf">53.346</span> <span class="p">[</span><span class="n">debug</span><span class="p">]</span> <span class="nc">QUERY</span> <span class="nc">OK</span> <span class="n">db</span><span class="o">=</span><span class="mf">1.2</span><span class="n">ms</span>
<span class="nc">INSERT</span> <span class="nc">INTO</span> <span class="s2">&#34;projects&#34;</span> <span class="p">(</span><span class="s2">&#34;name&#34;</span><span class="p">,</span><span class="s2">&#34;inserted_at&#34;</span><span class="p">,</span><span class="s2">&#34;updated_at&#34;</span><span class="p">)</span> <span class="nc">VALUES</span> <span class="p">(</span><span class="err">$</span><span class="mi">1</span><span class="p">,</span><span class="err">$</span><span class="mi">2</span><span class="p">,</span><span class="err">$</span><span class="mi">3</span><span class="p">)</span> <span class="nc">RETURNING</span> <span class="s2">&#34;id&#34;</span> <span class="p">[</span><span class="s2">&#34;Explain ecto transactions&#34;</span><span class="p">,</span> <span class="p">{{</span><span class="mi">2016</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">21</span><span class="p">},</span> <span class="p">{</span><span class="mi">3</span><span class="p">,</span> <span class="mi">49</span><span class="p">,</span> <span class="mi">53</span><span class="p">,</span> <span class="mi">0</span><span class="p">}},</span> <span class="p">{{</span><span class="mi">2016</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">21</span><span class="p">},</span> <span class="p">{</span><span class="mi">3</span><span class="p">,</span> <span class="mi">49</span><span class="p">,</span> <span class="mi">53</span><span class="p">,</span> <span class="mi">0</span><span class="p">}}]</span>
<span class="c1">#Ecto.Changeset&lt;action: :insert, changes: %{},</span>
 <span class="ss">errors</span><span class="p">:</span> <span class="p">[</span><span class="ss">description</span><span class="p">:</span> <span class="p">{</span><span class="s2">&#34;can&#39;t be blank&#34;</span><span class="p">,</span> <span class="p">[]}],</span> <span class="ss">data</span><span class="p">:</span> <span class="c1">#EctoTransactions.Task&lt;&gt;,</span>
 <span class="ss">valid?</span><span class="p">:</span> <span class="n">false</span><span class="o">&gt;</span>

<span class="mi">22</span><span class="p">:</span><span class="mi">49</span><span class="p">:</span><span class="mf">53.348</span> <span class="p">[</span><span class="n">debug</span><span class="p">]</span> <span class="nc">QUERY</span> <span class="nc">OK</span> <span class="n">db</span><span class="o">=</span><span class="mf">0.2</span><span class="n">ms</span>
<span class="n">rollback</span> <span class="p">[]</span>
<span class="p">{</span><span class="ss">:error</span><span class="p">,</span> <span class="ss">:task</span><span class="p">}</span>
<span class="n">iex</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span><span class="o">&gt;</span></code></pre></div>
<p>If you read with attention you will see two tupples <code>{:error, :project}</code> and <code>{:error, :task}</code> with this you can make the assumptions that you want, of course you could say a lot more and instead of returning tupples you return other things with more sense for example change <code>:project</code> or <code>:task</code> for his respective <code>changeset</code> and you should see other things.</p>
<p>By the way when use <code>Repo.transaction</code> you should return the implicit data (that is the schema you are saving) that&rsquo;s because <code>Repo.transaction</code> return a tupple consisting of an <code>:ok</code> atom and the respective last instruction. And if you use <code>Repo.insert</code> as returning data you will see a tupple of tupple <code>{:ok, {:ok, data}}</code> or <code>{:ok, {:error, data}}</code> (thats because the return of an insert is <code>{:ok, data}</code> or <code>{:error, data}</code>) and that&rsquo;s why we use <code>Repo.rollback</code> for forcing a tupple consisting of <code>{:error, reason}</code></p>
<p>That&rsquo;s all folks! I hope this can help you. And remember Good Luck, Have Fun! and GG!</p>


        
          <div class="blog-tags">
            
              <a href="https://blog.makingdevs.com//tags/elixir/">elixir</a>&nbsp;
            
              <a href="https://blog.makingdevs.com//tags/ecto/">ecto</a>&nbsp;
            
          </div>
        

        

        
      </article>

      
        <ul class="pager blog-pager">
          
            <li class="previous">
              <a href="https://blog.makingdevs.com/2016/09/10/routing-en-elm/" data-toggle="tooltip" data-placement="top" title="Routing en Elm">&larr; Previous Post</a>
            </li>
          
          
            <li class="next">
              <a href="https://blog.makingdevs.com/2016/11/05/fizzbuzz/" data-toggle="tooltip" data-placement="top" title="FizzBuzz">Next Post &rarr;</a>
            </li>
          
        </ul>
      


      
        
          
          <div class="disqus-comments">
            <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "makingdevs" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
          </div>
          
        
        
      

    </div>
  </div>
</div>

      
<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          
              <li>
                <a href="mailto:info@makingdevs.com" title="Email me">
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fas fa-envelope fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://www.facebook.com/makingdevs" title="Facebook">
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fab fa-facebook fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://github.com/makingdevs" title="GitHub">
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fab fa-github fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://gitlab.com/makingdevs" title="GitLab">
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fab fa-gitlab fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://twitter.com/makingdevs" title="Twitter">
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fab fa-twitter fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://www.youtube.com/makingdevs" title="Youtube">
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fab fa-youtube fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
          
          <li>
            <a href="" title="RSS">
              <span class="fa-stack fa-lg">
                <i class="fas fa-circle fa-stack-2x"></i>
                <i class="fas fa-rss fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
        </ul>
        <p class="credits copyright text-muted">
          

          &nbsp;&bull;&nbsp;&copy;
          
            2020
          

          
            &nbsp;&bull;&nbsp;
            <a href="https://blog.makingdevs.com/">Blog de Making Devs</a>
          
        </p>
        
        <p class="credits theme-by text-muted">
          <a href="https://gohugo.io">Hugo v0.74.2</a> powered &nbsp;&bull;&nbsp; Theme <a href="https://github.com/halogenica/beautifulhugo">Beautiful Hugo</a> adapted from <a href="https://deanattali.com/beautiful-jekyll/">Beautiful Jekyll</a>
          
        </p>
      </div>
    </div>
  </div>
</footer><script src="https://blog.makingdevs.com/js/katex.min.js"></script>
<script src="https://blog.makingdevs.com/js/auto-render.min.js"></script>
<script src="https://blog.makingdevs.com/js/jquery.min.js"></script>
<script src="https://blog.makingdevs.com/js/bootstrap.min.js"></script>

<script src="https://blog.makingdevs.com/js/main.js"></script>
<script src="https://blog.makingdevs.com/js/highlight.min.js"></script>
<script> hljs.initHighlightingOnLoad(); </script>
<script> $(document).ready(function() {$("pre.chroma").css("padding","0");}); </script><script> renderMathInElement(document.body); </script><script src="https://blog.makingdevs.com/js/photoswipe.min.js"></script>
<script src="https://blog.makingdevs.com/js/photoswipe-ui-default.min.js"></script><script src="https://blog.makingdevs.com/js/load-photoswipe.js"></script>









    
  </body>
</html>

